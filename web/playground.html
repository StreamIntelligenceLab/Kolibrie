<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Kolibrie Playground</title>

  <!-- CodeMirror CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- IBM Plex Mono Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
    rel="stylesheet">

  <!-- LZ-String for compression -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

  <style>
    /* Reset & Base */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d1b3d 50%, #1a1a1a 100%);
      color: #e0e0e0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
    }

    /* Static background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(219, 88, 156, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(219, 88, 156, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(219, 88, 156, 0.08) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    /* Toolbar */
    .toolbar {
      position: relative;
      z-index: 2;
      display: flex;
      align-items: center;
      background: linear-gradient(90deg, rgba(43, 43, 43, 0.95) 0%, rgba(45, 27, 61, 0.95) 100%);
      backdrop-filter: blur(10px);
      padding: 0 16px;
      height: 56px;
      min-height: 56px;
      border-bottom: 1px solid rgba(219, 88, 156, 0.3);
      box-shadow: 0 2px 20px rgba(219, 88, 156, 0.1);
      flex-shrink: 0;
    }

    .btn {
      margin-right: 12px;
      padding: 0 16px;
      height: 36px;
      line-height: 36px;
      font-size: 13px;
      font-weight: 600;
      color: #db589c;
      background: linear-gradient(135deg, rgba(219, 88, 156, 0.1) 0%, rgba(219, 88, 156, 0.05) 100%);
      border: 1px solid rgba(219, 88, 156, 0.4);
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(219, 88, 156, 0.2), transparent);
      opacity: 0;
    }

    .btn:hover {
      background: linear-gradient(135deg, rgba(219, 88, 156, 0.2) 0%, rgba(219, 88, 156, 0.1) 100%);
      border-color: rgba(219, 88, 156, 0.6);
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(219, 88, 156, 0.2);
    }

    .btn:active {
      transform: translateY(0px);
      background: rgba(219, 88, 156, 0.3);
    }

    /* Multi-query controls */
    .multi-query-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      padding: 8px;
      background: rgba(45, 27, 61, 0.3);
      border-radius: 8px;
      border: 1px solid rgba(219, 88, 156, 0.2);
    }

    .btn-add-query {
      padding: 6px 12px;
      font-size: 12px;
      height: 32px;
      line-height: 20px;
      margin: 0;
    }

    /* Rules info banner */
    .rules-info-banner {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 8px;
      padding: 12px;
      background: rgba(45, 27, 61, 0.4);
      border-radius: 8px;
      border: 1px solid rgba(219, 88, 156, 0.3);
      font-size: 13px;
      line-height: 1.6;
    }

    .rules-info-banner i {
      color: #db589c;
      font-size: 16px;
      margin-top: 2px;
      flex-shrink: 0;
    }

    .rules-info-content {
      flex: 1;
    }

    .rules-info-content strong {
      color: #db589c;
      display: block;
      margin-bottom: 4px;
    }

    .rules-info-content p {
      margin: 0;
      color: #c0c0c0;
    }

    .rules-info-content code {
      background: rgba(219, 88, 156, 0.15);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'IBM Plex Mono', monospace;
      color: #db589c;
      font-size: 12px;
    }

    /* Query tabs */
    .query-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .query-tab {
      padding: 6px 12px;
      font-size: 12px;
      height: 32px;
      color: #e0e0e0;
      background: rgba(43, 43, 43, 0.6);
      border: 1px solid rgba(219, 88, 156, 0.3);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .query-tab.active {
      background: linear-gradient(135deg, rgba(219, 88, 156, 0.3) 0%, rgba(219, 88, 156, 0.2) 100%);
      border-color: rgba(219, 88, 156, 0.6);
      color: #db589c;
      font-weight: 600;
    }

    .query-tab:hover {
      background: rgba(219, 88, 156, 0.2);
      border-color: rgba(219, 88, 156, 0.5);
    }

    .dropdown {
      position: relative;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: linear-gradient(135deg, rgba(43, 43, 43, 0.95) 0%, rgba(45, 27, 61, 0.95) 100%);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(219, 88, 156, 0.4);
      border-radius: 8px;
      margin-top: 8px;
      overflow: hidden;
      z-index: 10;
      box-shadow: 0 8px 32px rgba(219, 88, 156, 0.15);
      animation: dropIn 0.15s ease-out;
    }

    @keyframes dropIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dropdown.open .dropdown-menu {
      display: block;
    }

    .dropdown-menu .item {
      padding: 12px 16px;
      cursor: pointer;
      color: #e0e0e0;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(219, 88, 156, 0.1);
    }

    .dropdown-menu .item:last-child {
      border-bottom: none;
    }

    .dropdown-menu .item:hover {
      background: rgba(219, 88, 156, 0.15);
      color: #db589c;
    }

    /* Config Panel & Share Panel */
    .config-panel,
    .share-panel {
      position: fixed;
      top: 0;
      right: -350px;
      width: 350px;
      height: 100vh;
      background: linear-gradient(135deg, rgba(26, 26, 26, 0.98) 0%, rgba(45, 27, 61, 0.98) 100%);
      backdrop-filter: blur(20px);
      border-left: 1px solid rgba(219, 88, 156, 0.3);
      box-shadow: -5px 0 20px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .config-panel.open,
    .share-panel.open {
      right: 0;
    }

    .config-header,
    .share-header {
      padding: 20px;
      border-bottom: 1px solid rgba(219, 88, 156, 0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .config-title,
    .share-title {
      font-size: 18px;
      font-weight: 600;
      color: #db589c;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .config-close,
    .share-close {
      width: 32px;
      height: 32px;
      background: transparent;
      border: 1px solid rgba(219, 88, 156, 0.4);
      border-radius: 6px;
      color: #db589c;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
    }

    .config-close:hover,
    .share-close:hover {
      background: rgba(219, 88, 156, 0.1);
      border-color: rgba(219, 88, 156, 0.6);
    }

    .config-content,
    .share-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .config-section {
      margin-bottom: 24px;
    }

    .config-section h3 {
      font-size: 14px;
      font-weight: 600;
      color: #db589c;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .config-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(219, 88, 156, 0.1);
    }

    .config-row:last-child {
      border-bottom: none;
    }

    .config-label {
      color: #e0e0e0;
      font-size: 13px;
    }

    .config-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .config-btn {
      width: 28px;
      height: 28px;
      background: rgba(219, 88, 156, 0.1);
      border: 1px solid rgba(219, 88, 156, 0.4);
      border-radius: 6px;
      color: #db589c;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .config-btn:hover {
      background: rgba(219, 88, 156, 0.2);
      border-color: rgba(219, 88, 156, 0.6);
    }

    .config-value {
      min-width: 50px;
      text-align: center;
      color: #db589c;
      font-size: 13px;
      font-weight: 600;
    }

    .config-select {
      background: rgba(43, 43, 43, 0.6);
      border: 1px solid rgba(219, 88, 156, 0.4);
      border-radius: 6px;
      color: #e0e0e0;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .config-select:hover {
      background: rgba(219, 88, 156, 0.1);
      border-color: rgba(219, 88, 156, 0.6);
    }

    .config-select:focus {
      outline: none;
      border-color: rgba(219, 88, 156, 0.8);
    }

    .share-url-container {
      margin-bottom: 16px;
    }

    .share-url-label {
      color: #db589c;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .share-url-input {
      width: 100%;
      background: rgba(43, 43, 43, 0.6);
      border: 1px solid rgba(219, 88, 156, 0.4);
      border-radius: 6px;
      color: #e0e0e0;
      padding: 10px 12px;
      font-size: 13px;
      font-family: 'IBM Plex Mono', monospace;
      resize: vertical;
      min-height: 80px;
    }

    .share-url-input:focus {
      outline: none;
      border-color: rgba(219, 88, 156, 0.8);
    }

    .share-copy-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, rgba(219, 88, 156, 0.2) 0%, rgba(219, 88, 156, 0.1) 100%);
      border: 1px solid rgba(219, 88, 156, 0.4);
      border-radius: 6px;
      color: #db589c;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.2s ease;
    }

    .share-copy-btn:hover {
      background: linear-gradient(135deg, rgba(219, 88, 156, 0.3) 0%, rgba(219, 88, 156, 0.2) 100%);
      border-color: rgba(219, 88, 156, 0.6);
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(219, 88, 156, 0.2);
    }

    .share-copy-btn.copied {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(76, 175, 80, 0.1) 100%);
      border-color: rgba(76, 175, 80, 0.6);
      color: #4caf50;
    }

    /* Overlay */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .overlay.open {
      display: block;
    }

    /* Container */
    .container {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 60px;
      background: linear-gradient(180deg, rgba(43, 43, 43, 0.95) 0%, rgba(45, 27, 61, 0.95) 100%);
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(219, 88, 156, 0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 0;
      gap: 12px;
      flex-shrink: 0;
    }

    .sidebar-btn {
      width: 44px;
      height: 44px;
      background: rgba(219, 88, 156, 0.1);
      border: 1px solid rgba(219, 88, 156, 0.3);
      border-radius: 8px;
      color: #db589c;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s ease;
    }

    .sidebar-btn:hover {
      background: rgba(219, 88, 156, 0.2);
      border-color: rgba(219, 88, 156, 0.5);
      transform: translateX(2px);
    }

    .sidebar-btn.active {
      background: linear-gradient(135deg, rgba(219, 88, 156, 0.3) 0%, rgba(219, 88, 156, 0.2) 100%);
      border-color: rgba(219, 88, 156, 0.6);
      box-shadow: 0 4px 15px rgba(219, 88, 156, 0.2);
    }

    /* Mode Container */
    .mode-container {
      flex: 1;
      position: relative;
    }

    .mode-content {
      display: none;
      width: 100%;
      height: 100%;
    }

    .mode-content.active {
      display: block;
    }

    /* Editor Container */
    .editor-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: rgba(26, 26, 26, 0.5);
    }

    .editor-tabs {
      display: flex;
      gap: 4px;
      padding: 12px 16px 0;
      background: rgba(43, 43, 43, 0.3);
      border-bottom: 1px solid rgba(219, 88, 156, 0.2);
    }

    .editor-tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: #c0c0c0;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.2s ease;
    }

    .editor-tab:hover {
      color: #db589c;
      background: rgba(219, 88, 156, 0.05);
    }

    .editor-tab.active {
      color: #db589c;
      border-bottom-color: #db589c;
      background: rgba(219, 88, 156, 0.1);
    }

    .editor-panel {
      display: none;
      flex: 1;
      padding: 16px;
      overflow: hidden;
      flex-direction: column;
    }

    .editor-panel.active {
      display: flex;
    }

    /* CodeMirror styling */
    .CodeMirror {
      height: 100% !important;
      background: rgba(43, 43, 43, 0.6) !important;
      border: 1px solid rgba(219, 88, 156, 0.3);
      border-radius: 8px;
      font-family: 'IBM Plex Mono', monospace !important;
      font-size: 14px !important;
    }

    .CodeMirror-gutters {
      background: rgba(35, 35, 35, 0.8) !important;
      border-right: 1px solid rgba(219, 88, 156, 0.2);
    }

    .CodeMirror-linenumber {
      color: rgba(219, 88, 156, 0.5);
    }

    .CodeMirror-cursor {
      border-left-color: #db589c !important;
    }

    .CodeMirror-selected {
      background: rgba(219, 88, 156, 0.2) !important;
    }

    /* Resizer */
    .resizer {
      height: 6px;
      background: rgba(219, 88, 156, 0.1);
      cursor: ns-resize;
      position: relative;
      transition: background 0.2s ease;
    }

    .resizer:hover {
      background: rgba(219, 88, 156, 0.3);
    }

    .resizer::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 3px;
      background: rgba(219, 88, 156, 0.4);
      border-radius: 2px;
    }

    /* Results Panel */
    .results-panel {
      min-height: 200px;
      max-height: 60%;
      display: flex;
      flex-direction: column;
      background: rgba(26, 26, 26, 0.8);
      border-top: 1px solid rgba(219, 88, 156, 0.3);
    }

    .results-header {
      padding: 12px 16px;
      background: linear-gradient(90deg, rgba(43, 43, 43, 0.8) 0%, rgba(45, 27, 61, 0.8) 100%);
      border-bottom: 1px solid rgba(219, 88, 156, 0.2);
      font-size: 13px;
      font-weight: 600;
      color: #db589c;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .results-content {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 13px;
      line-height: 1.6;
    }

    /* Terminal output styling */
    .terminal-output {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 6px;
      border-left: 3px solid transparent;
      white-space: pre-line;
    }

    .terminal-success {
      background: rgba(76, 175, 80, 0.1);
      border-left-color: #4caf50;
      color: #81c784;
    }

    .terminal-error {
      background: rgba(244, 67, 54, 0.1);
      border-left-color: #f44336;
      color: #e57373;
    }

    .terminal-warning {
      background: rgba(255, 152, 0, 0.1);
      border-left-color: #ff9800;
      color: #ffb74d;
    }

    .terminal-info {
      background: rgba(33, 150, 243, 0.1);
      border-left-color: #2196f3;
      color: #64b5f6;
    }

    .query-result-section {
      margin-bottom: 24px;
      padding: 12px;
      background: rgba(43, 43, 43, 0.3);
      border-radius: 8px;
      border: 1px solid rgba(219, 88, 156, 0.2);
    }

    /* Results Table */
    .table-wrapper {
      overflow-x: auto;
      margin-top: 12px;
      border-radius: 6px;
      border: 1px solid rgba(219, 88, 156, 0.2);
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(43, 43, 43, 0.4);
    }

    .results-table th {
      background: linear-gradient(135deg, rgba(219, 88, 156, 0.2) 0%, rgba(219, 88, 156, 0.1) 100%);
      color: #db589c;
      padding: 10px 14px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5px;
      border-bottom: 1px solid rgba(219, 88, 156, 0.3);
    }

    .results-table td {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(219, 88, 156, 0.1);
      color: #e0e0e0;
    }

    .results-table tr:last-child td {
      border-bottom: none;
    }

    .results-table tr:hover {
      background: rgba(219, 88, 156, 0.05);
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(43, 43, 43, 0.3);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(219, 88, 156, 0.4);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(219, 88, 156, 0.6);
    }

    /* Help Modal */
    .help-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .help-modal.open {
      display: flex;
    }

    .help-content {
      background: linear-gradient(135deg, rgba(26, 26, 26, 0.98) 0%, rgba(45, 27, 61, 0.98) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(219, 88, 156, 0.4);
      border-radius: 12px;
      padding: 32px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 50px rgba(219, 88, 156, 0.2);
    }

    .help-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .help-title {
      font-size: 24px;
      font-weight: 600;
      color: #db589c;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .help-close {
      width: 32px;
      height: 32px;
      background: transparent;
      border: 1px solid rgba(219, 88, 156, 0.4);
      border-radius: 6px;
      color: #db589c;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
    }

    .help-close:hover {
      background: rgba(219, 88, 156, 0.1);
      border-color: rgba(219, 88, 156, 0.6);
    }

    .help-body {
      color: #e0e0e0;
      line-height: 1.8;
    }

    .help-body h3 {
      color: #db589c;
      margin-top: 20px;
      margin-bottom: 12px;
      font-size: 16px;
    }

    .help-body p {
      margin-bottom: 12px;
    }

    .help-body code {
      background: rgba(219, 88, 156, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'IBM Plex Mono', monospace;
      color: #db589c;
    }

    .help-body ul {
      margin-left: 20px;
      margin-bottom: 12px;
    }

    .help-body li {
      margin-bottom: 8px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .toolbar {
        padding: 0 8px;
        height: 48px;
      }

      .btn {
        padding: 0 12px;
        height: 32px;
        line-height: 32px;
        font-size: 12px;
      }

      .sidebar {
        width: 50px;
      }

      .sidebar-btn {
        width: 38px;
        height: 38px;
        font-size: 16px;
      }

      .config-panel,
      .share-panel {
        width: 100%;
        right: -100%;
      }

      .help-content {
        margin: 20px;
        padding: 24px;
      }
    }

    /* Hidden utility */
    .hidden {
      display: none !important;
    }

    /* Rule sub-tabs (Rules / N3 Logic) inside the Rules editor panel */
    .rule-subtabs {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
    }

    .rule-subtab {
      padding: 5px 14px;
      font-size: 12px;
      height: 28px;
      line-height: 18px;
      color: #c0c0c0;
      background: rgba(43, 43, 43, 0.5);
      border: 1px solid rgba(219, 88, 156, 0.25);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .rule-subtab.active {
      background: linear-gradient(135deg, rgba(219, 88, 156, 0.3) 0%, rgba(219, 88, 156, 0.15) 100%);
      border-color: rgba(219, 88, 156, 0.6);
      color: #db589c;
      font-weight: 600;
    }

    .rule-subtab:hover:not(.active) {
      background: rgba(219, 88, 156, 0.15);
      border-color: rgba(219, 88, 156, 0.4);
      color: #db589c;
    }

    .rule-subpanel {
      display: none;
      flex: 1;
      flex-direction: column;
      min-height: 0;
    }

    .rule-subpanel.active {
      display: flex;
    }

    /* N3 Logic info badge shown inside the N3 Logic sub-panel */
    .n3logic-info-badge {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 8px;
      padding: 10px 12px;
      background: rgba(45, 27, 61, 0.35);
      border-radius: 7px;
      border: 1px solid rgba(219, 88, 156, 0.25);
      font-size: 12px;
      line-height: 1.55;
      color: #b0b0b0;
      flex-shrink: 0;
    }

    .n3logic-info-badge i {
      color: #db589c;
      font-size: 14px;
      margin-top: 1px;
      flex-shrink: 0;
    }

    .n3logic-info-badge code {
      background: rgba(219, 88, 156, 0.15);
      padding: 1px 5px;
      border-radius: 3px;
      font-family: 'IBM Plex Mono', monospace;
      color: #db589c;
      font-size: 11px;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Toolbar -->
    <div class="toolbar">
      <button class="btn" id="runBtn">
        <i class="fas fa-play"></i> Run
      </button>

      <div class="dropdown" id="formatDropdown">
        <button class="btn" id="formatBtn">
          <i class="fas fa-file-code"></i> Format: <span id="formatLabel">RDF/XML</span>
        </button>
        <div class="dropdown-menu">
          <div class="item" data-format="rdfxml">RDF/XML</div>
          <div class="item" data-format="ntriples">N-Triples</div>
          <div class="item" data-format="turtle">Turtle Dataset</div>
        </div>
      </div>

      <button class="btn" id="shareBtn">
        <i class="fas fa-share-nodes"></i> Share
      </button>

      <button class="btn" id="helpBtn">
        <i class="fas fa-circle-question"></i> Help
      </button>

      <button class="btn" id="configBtn">
        <i class="fas fa-gear"></i> Settings
      </button>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Sidebar -->
      <div class="sidebar">
        <button class="sidebar-btn active" data-mode="sparql" title="SPARQL Mode">
          <i class="fas fa-database"></i>
        </button>
        <button class="sidebar-btn" data-mode="rsp" title="RSP Mode">
          <i class="fas fa-stream"></i>
        </button>
      </div>

      <!-- Mode Container -->
      <div class="mode-container">
        <!-- SPARQL Mode -->
        <div id="sparql-mode" class="mode-content active">
          <div class="editor-container" id="editor-container">
            <div class="editor-tabs">
              <button class="editor-tab active" data-tab="sparql">SPARQL Query</button>
              <button class="editor-tab" data-tab="rdf">RDF Data</button>
              <button class="editor-tab" data-tab="rules">Rules</button>
            </div>

            <!-- SPARQL Panel -->
            <div class="editor-panel active" data-panel="sparql" id="sparql-panel">
              <!-- Multi-query controls -->
              <div class="multi-query-controls">
                <button class="btn btn-add-query" id="addQueryBtn"><i class="fas fa-plus"></i> Add Query</button>
              </div>
              <!-- Query tabs -->
              <div class="query-tabs" id="queryTabs">
                <button class="query-tab active" data-query-index="0">Query 1</button>
              </div>
              <textarea id="sparql-editor">PREFIX ex: <http://example.org#>
SELECT ?room
WHERE { 
  ?room ex:overheatingAlert true . 
}</textarea>
            </div>

            <!-- RDF Panel -->
            <div class="editor-panel" data-panel="rdf">
              <textarea id="rdf-editor"><?xml version="1.0"?>
<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
        xmlns:ex="http://example.org#">
<rdf:Description rdf:about="http://example.org#Room101">
    <ex:temperature>75</ex:temperature>
    <ex:room>Room101</ex:room>
</rdf:Description>
<rdf:Description rdf:about="http://example.org#Sensor1">
    <ex:room>Room101</ex:room>
    <ex:temperature>90</ex:temperature>
</rdf:Description>
<rdf:Description rdf:about="http://example.org#Room102">
    <ex:temperature>35</ex:temperature>
    <ex:room>Room102</ex:room>
</rdf:Description>
<rdf:Description rdf:about="http://example.org#Sensor2">
    <ex:room>Room102</ex:room>
    <ex:temperature>70</ex:temperature>
</rdf:Description>
<rdf:Description rdf:about="http://example.org#Room103">
    <ex:temperature>45</ex:temperature>
    <ex:room>Room103</ex:room>
</rdf:Description>
<rdf:Description rdf:about="http://example.org#Sensor3">
    <ex:room>Room103</ex:room>
    <ex:temperature>190</ex:temperature>
</rdf:Description>
</rdf:RDF></textarea>
            </div>

            <!-- Rules Panel -->
            <div class="editor-panel" data-panel="rules" id="rules-panel">

              <!-- Sub-tab switcher: Rules vs N3 Logic -->
              <div class="rule-subtabs">
                <button class="rule-subtab active" id="ruleSubtabRules" onclick="switchRuleSubtab('rules')">
                  <i class="fas fa-code-branch"></i> Rules
                </button>
                <button class="rule-subtab" id="ruleSubtabN3Logic" onclick="switchRuleSubtab('n3logic')">
                  <i class="fas fa-code"></i> N3 Logic
                </button>
              </div>

              <!-- ── RULES sub-panel ── -->
              <div class="rule-subpanel active" id="ruleSubpanelRules">
                <!-- Multi-rule controls -->
                <div class="multi-query-controls">
                  <button class="btn btn-add-query" id="addRuleBtn"><i class="fas fa-plus"></i> Add Rule Tab</button>
                </div>
                <!-- Rule tabs -->
                <div class="query-tabs" id="ruleTabs">
                  <button class="query-tab active" data-rule-index="0">Rule Set 1</button>
                </div>
                <textarea id="rules-editor">PREFIX ex: <http://example.org#>
RULE :OverheatingAlert :- 
CONSTRUCT { 
    ?room ex:overheatingAlert true .
}
WHERE { 
    ?reading ex:room ?room ; 
            ex:temperature ?temp
    FILTER (?temp > 80)
}

# Add more rules below to extend inference
# Each rule will be applied in order</textarea>
              </div>

              <!-- ── N3 LOGIC sub-panel ── -->
              <div class="rule-subpanel" id="ruleSubpanelN3Logic">
                <div class="n3logic-info-badge">
                  <i class="fas fa-circle-info"></i>
                  <span>
                    Write N3 logic rules here using <strong style="color:#db589c;">N3 Logic</strong> syntax.
                    They are merged with your main RDF data before rules and queries run.
                    Use <code>@prefix</code> declarations as normal — they are scoped to this block only.
                  </span>
                </div>
                <textarea id="n3logic-editor">@prefix ex: <http://example.org#> .

# Extra triples injected alongside your main RDF data
# ex:Room101 ex:building ex:BuildingA .
</textarea>
              </div>

            </div>

            <!-- Resizer -->
            <div class="resizer" id="resizer"></div>

            <!-- Results Panel -->
            <div class="results-panel" id="results-panel">
              <div class="results-header">
                <i class="fas fa-terminal"></i> Results
              </div>
              <div class="results-content" id="results-content"></div>
            </div>
          </div>
        </div>

        <!-- RSP Mode -->
        <div id="rsp-mode" class="mode-content">
          <div class="editor-container">
            <div class="editor-tabs">
              <button class="editor-tab active" data-tab="rsp-sparql">RSP-QL Query</button>
            </div>

            <div class="editor-panel active" data-panel="rsp-sparql">
              <textarea id="rsp-sparql-editor">PREFIX ex: <http://example.org#>
REGISTER STREAM <http://example.org/stream> AS
SELECT ?reading ?temp
FROM NAMED WINDOW :window ON <http://example.org/stream> [RANGE PT10S STEP PT5S]
WHERE {
  WINDOW :window {
    ?reading ex:temperature ?temp .
    FILTER (?temp > 80)
  }
}</textarea>
            </div>

            <div class="resizer" id="resizer-rsp"></div>

            <div class="results-panel" id="results-panel-rsp">
              <div class="results-header">
                <i class="fas fa-terminal"></i> Stream Results
              </div>
              <div class="results-content" id="results-content-rsp"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Config Panel -->
  <div class="config-panel" id="configPanel">
    <div class="config-header">
      <div class="config-title">Settings</div>
      <button class="config-close" id="configClose">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="config-content">
      <div class="config-section">
        <h3>Editor</h3>
        <div class="config-row">
          <div class="config-label">Font Size</div>
          <div class="config-controls">
            <button class="config-btn" id="editorFontDecrease">
              <i class="fas fa-minus"></i>
            </button>
            <div class="config-value" id="editorFontSize">14px</div>
            <button class="config-btn" id="editorFontIncrease">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="config-section">
        <h3>Terminal</h3>
        <div class="config-row">
          <div class="config-label">Font Size</div>
          <div class="config-controls">
            <button class="config-btn" id="terminalFontDecrease">
              <i class="fas fa-minus"></i>
            </button>
            <div class="config-value" id="terminalFontSize">13px</div>
            <button class="config-btn" id="terminalFontIncrease">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="config-section">
        <h3>Theme</h3>
        <div class="config-row">
          <div class="config-label">Color Scheme</div>
          <select class="config-select" id="themeSelect">
            <option value="purple">Purple (Default)</option>
            <option value="blue">Blue</option>
            <option value="green">Green</option>
            <option value="orange">Orange</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Share Panel -->
  <div class="share-panel" id="sharePanel">
    <div class="share-header">
      <div class="share-title">Share</div>
      <button class="share-close" id="shareClose">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="share-content">
      <div class="share-url-container">
        <div class="share-url-label">Shareable URL</div>
        <textarea class="share-url-input" id="shareUrlInput" readonly></textarea>
      </div>
      <button class="share-copy-btn" id="shareCopyBtn">
        <i class="fas fa-copy"></i> Copy to Clipboard
      </button>
    </div>
  </div>

  <!-- Config Overlay -->
  <div class="overlay" id="configOverlay"></div>

  <!-- Help Modal -->
  <div class="help-modal" id="helpModal">
    <div class="help-content">
      <div class="help-header">
        <div class="help-title">Help</div>
        <button class="help-close" id="helpClose">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="help-body">
        <h3>Getting Started</h3>
        <p>Kolibrie Playground is an interactive environment for SPARQL queries and RDF data processing with rule-based inference.</p>

        <h3>Basic Usage</h3>
        <ul>
          <li><strong>SPARQL Query:</strong> Write your SPARQL SELECT or CONSTRUCT queries</li>
          <li><strong>RDF Data:</strong> Provide RDF data in RDF/XML or N-Triples format</li>
          <li><strong>Rules:</strong> Define inference rules to derive new facts</li>
          <li><strong>Run:</strong> Click the Run button to execute all queries</li>
        </ul>

        <h3>Multiple Queries</h3>
        <p>Click "Add Query" to create multiple query tabs for different tasks. Each query executes in sequence with the same data and rules.</p>

        <h3>Multiple Rules</h3>
        <p><strong>Same Task:</strong> Write multiple rules in the same rule tab. Each rule will be processed sequentially, allowing you to build complex inference chains.</p>
        <p><strong>Different Tasks:</strong> Click "Add Rule Tab" to create separate rule sets for different purposes.</p>

        <h3>Data Formats</h3>
        <ul>
          <li><strong>RDF/XML:</strong> Standard RDF XML format</li>
          <li><strong>N-Triples:</strong> Line-based triple format with Streamertail optimizer</li>
        </ul>

        <h3>Inference Rules</h3>
        <p>Rules use the syntax:</p>
        <code>RULE :RuleName :- CONSTRUCT { ... } WHERE { ... }</code>
        <p>Rules are applied before query execution to infer new triples.</p>

        <h3>N3 Logic (in Rules tab)</h3>
        <p>The <strong>Rules</strong> tab has two sub-tabs: <strong>Rules</strong> and <strong>N3 Logic</strong>.</p>
        <p>In the N3 Logic sub-tab you can write N3 logic inference rules:</p>
        <code>@prefix ex: &lt;http://example.org#&gt; .<br>ex:Room101 ex:building ex:BuildingA .</code>
        <p>These triples are automatically merged with the data in your RDF Data tab before rules and queries are executed. This is useful when you want to pair specific background knowledge directly with a rule set.</p>

        <h3>Sharing</h3>
        <p>Click "Share" to generate a URL containing your queries, data, and rules. The URL can be shared with others.</p>

        <h3>RSP Mode</h3>
        <p>Switch to RSP mode for RDF Stream Processing queries (under development).</p>
      </div>
    </div>
  </div>

  <!-- CodeMirror JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sparql/sparql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
  <!-- N3 Logic mode: lightweight syntax highlighting for CodeMirror 5 -->

  <script>
    // Minimal N3 Logic syntax highlighting for CodeMirror 5
    CodeMirror.defineMode('turtle', function() {
      var IRI_RE = /^<[^>]*>/;
      var PREFIX_NS_RE = /^[A-Za-z_][\w.-]*:/;
      var PREFIXED_NAME_RE = /^[A-Za-z_][\w.-]*:[A-Za-z_][\w.-]*/;
      var BLANK_RE = /^_:[A-Za-z_][\w.-]*/;
      var STRING1_RE = /^"(?:[^"\\]|\\.)*"/;
      var STRING2_RE = /^'(?:[^'\\]|\\.)*'/;
      var LANGTYPE_RE = /^@[a-zA-Z]+(?:-[a-zA-Z0-9]+)*/;
      var DATATYPE_RE = /^\^\^/;
      var KEYWORD_RE = /^(?:@prefix|@base|a|PREFIX|BASE)\b/;
      var PUNCT_RE = /^[.,;()[\]{}]/;
      var NUMBER_RE = /^[-+]?(?:\d+\.?\d*|\.\d+)(?:[eE][-+]?\d+)?/;

      return {
        startState: function() { return { expectDT: false }; },
        token: function(stream, state) {
          // Skip whitespace
          if (stream.eatSpace()) return null;

          // Comments
          if (stream.match(/^#.*/)) return 'comment';

          // Keywords / directives
          if (stream.match(KEYWORD_RE)) return 'keyword';

          // IRIs
          if (stream.match(IRI_RE)) return 'string-2';

          // Datatypes (^^<iri> or ^^prefix:local)
          if (state.expectDT) {
            state.expectDT = false;
            if (stream.match(IRI_RE) || stream.match(PREFIXED_NAME_RE)) return 'atom';
          }
          if (stream.match(DATATYPE_RE)) { state.expectDT = true; return 'meta'; }

          // Language tags
          if (stream.match(LANGTYPE_RE)) return 'meta';

          // Blank nodes
          if (stream.match(BLANK_RE)) return 'variable-2';

          // Prefixed names
          if (stream.match(PREFIXED_NAME_RE)) return 'atom';

          // Strings (triple-quoted first, then single-quoted)
          if (stream.match(/^"""[\s\S]*?"""/)) return 'string';
          if (stream.match(/^'''[\s\S]*?'''/)) return 'string';
          if (stream.match(STRING1_RE)) return 'string';
          if (stream.match(STRING2_RE)) return 'string';

          // Numbers
          if (stream.match(NUMBER_RE)) return 'number';

          // Punctuation
          if (stream.match(PUNCT_RE)) return 'punctuation';

          // Fallback: advance one char
          stream.next();
          return null;
        }
      };
    });
    CodeMirror.defineMIME('text/turtle', 'turtle');
  </script>

  <script>
    // Global state
    let currentMode = 'sparql';
    let selectedFormat = 'rdfxml';
    let currentQueryIndex = 0;
    let currentRuleIndex = 0;
    let currentRuleSubtab = 'rules'; // 'rules' | 'n3logic'
    let queryEditors = [];
    let rdfEditor;
    let ruleEditors = [];
    let n3logicEditor;          // single N3 Logic editor (shared across rule sets)
    let rspSparqlEditor;

    let config = {
      editorFontSize: 14,
      terminalFontSize: 13,
      theme: 'purple'
    };

    // Initialize editors
    function initializeEditors() {
      // Initialize first query editor
      const firstQueryEditor = CodeMirror.fromTextArea(document.getElementById('sparql-editor'), {
        mode: 'application/sparql-query',
        theme: 'dracula',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
      });
      queryEditors.push(firstQueryEditor);

      // Initialize RDF editor
      rdfEditor = CodeMirror.fromTextArea(document.getElementById('rdf-editor'), {
        mode: 'application/xml',
        theme: 'dracula',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
      });

      // Initialize first Rules editor
      const firstRuleEditor = CodeMirror.fromTextArea(document.getElementById('rules-editor'), {
        mode: 'application/sparql-query',
        theme: 'dracula',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
      });
      ruleEditors.push(firstRuleEditor);

      // Initialize RSP editor
      rspSparqlEditor = CodeMirror.fromTextArea(document.getElementById('rsp-sparql-editor'), {
        mode: 'application/sparql-query',
        theme: 'dracula',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
      });

      // Initialize N3 Logic editor (inside Rules > N3 Logic sub-panel)
      n3logicEditor = CodeMirror.fromTextArea(document.getElementById('n3logic-editor'), {
        mode: 'text/turtle',
        theme: 'dracula',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initializeEditors();
      setupEventListeners();
      setupResizer();
      setupResizerRsp();
      loadConfig();
      loadFromUrl();
    });

    // Mode switching
    function switchMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.sidebar-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      document.querySelectorAll('.mode-content').forEach(content => {
        content.classList.toggle('active', content.id === `${mode}-mode`);
      });
    }

    // Switch between rule sub-tabs: 'rules' or 'n3logic'
    function switchRuleSubtab(subtab) {
      currentRuleSubtab = subtab;

      document.getElementById('ruleSubtabRules').classList.toggle('active', subtab === 'rules');
      document.getElementById('ruleSubtabN3Logic').classList.toggle('active', subtab === 'n3logic');
      document.getElementById('ruleSubpanelRules').classList.toggle('active', subtab === 'rules');
      document.getElementById('ruleSubpanelN3Logic').classList.toggle('active', subtab === 'n3logic');

      if (subtab === 'rules') {
        ruleEditors.forEach(e => e.refresh());
      } else {
        if (n3logicEditor) n3logicEditor.refresh();
      }
    }

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.editor-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });
      document.querySelectorAll('.editor-panel').forEach(panel => {
        panel.classList.toggle('active', panel.dataset.panel === tabName);
      });
      
      // Refresh editors when switching tabs
      if (tabName === 'sparql') {
        queryEditors.forEach(e => e.refresh());
      } else if (tabName === 'rdf') {
        rdfEditor.refresh();
      } else if (tabName === 'rules') {
        ruleEditors.forEach(e => e.refresh());
        if (n3logicEditor) n3logicEditor.refresh();
      }
    }

    // Add new query editor
    function addQueryEditor() {
      const newIndex = queryEditors.length;
      
      const textarea = document.createElement('textarea');
      textarea.id = `sparql-editor-${newIndex}`;
      textarea.value = `PREFIX ex: <http://example.org#>
SELECT ?s ?p ?o
WHERE { 
  ?s ?p ?o
}`;
      
      document.getElementById('sparql-panel').appendChild(textarea);
      
      const editor = CodeMirror.fromTextArea(textarea, {
        mode: 'application/sparql-query',
        theme: 'dracula',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
      });
      
      editor.getWrapperElement().style.display = 'none';
      queryEditors.push(editor);

      const tab = document.createElement('button');
      tab.className = 'query-tab';
      tab.dataset.queryIndex = newIndex;
      tab.textContent = `Query ${newIndex + 1}`;
      tab.addEventListener('click', () => switchToQuery(newIndex));
      document.getElementById('queryTabs').appendChild(tab);

      switchToQuery(newIndex);
    }

    // Switch between query editors
    function switchToQuery(index) {
      queryEditors.forEach((editor, i) => {
        const wrapper = editor.getWrapperElement();
        const tab = document.querySelector(`[data-query-index="${i}"]`);
        
        if (i === index) {
          wrapper.style.display = 'block';
          if (tab) tab.classList.add('active');
          editor.refresh();
        } else {
          wrapper.style.display = 'none';
          if (tab) tab.classList.remove('active');
        }
      });
      currentQueryIndex = index;
    }

    // Add new rule editor
    function addRuleEditor() {
      const newIndex = ruleEditors.length;
      
      const textarea = document.createElement('textarea');
      textarea.id = `rules-editor-${newIndex}`;
      textarea.value = `PREFIX ex: <http://example.org#>
RULE :NewRule :- 
CONSTRUCT { 
    ?s ex:newProperty ?o .
}
WHERE { 
    ?s ex:someProperty ?o .
}

# Add more rules below to extend inference`;
      
      document.getElementById('rules-panel').appendChild(textarea);
      
      const editor = CodeMirror.fromTextArea(textarea, {
        mode: 'application/sparql-query',
        theme: 'dracula',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
      });
      
      editor.getWrapperElement().style.display = 'none';
      ruleEditors.push(editor);

      const tab = document.createElement('button');
      tab.className = 'query-tab';
      tab.dataset.ruleIndex = newIndex;
      tab.textContent = `Rule Set ${newIndex + 1}`;
      tab.addEventListener('click', () => switchToRule(newIndex));
      document.getElementById('ruleTabs').appendChild(tab);

      switchToRule(newIndex);
    }

    // Switch between rule editors
    function switchToRule(index) {
      ruleEditors.forEach((editor, i) => {
        const wrapper = editor.getWrapperElement();
        const tab = document.querySelector(`[data-rule-index="${i}"]`);
        
        if (i === index) {
          wrapper.style.display = 'block';
          if (tab) tab.classList.add('active');
          editor.refresh();
        } else {
          wrapper.style.display = 'none';
          if (tab) tab.classList.remove('active');
        }
      });
      currentRuleIndex = index;
    }

    function setupEventListeners() {
      // Add Query button
      document.getElementById('addQueryBtn').addEventListener('click', addQueryEditor);
      
      // Add Rule button
      document.getElementById('addRuleBtn').addEventListener('click', addRuleEditor);

      // Mode switching
      document.querySelectorAll('.sidebar-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const mode = btn.dataset.mode;
          switchMode(mode);
        });
      });

      // Tab switching
      document.querySelectorAll('.editor-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          switchTab(tabName);
        });
      });

      // Run button
      document.getElementById('runBtn').addEventListener('click', () => {
        if (currentMode === 'sparql') {
          executeKolibrieQuery();
        } else {
          executeRspQuery();
        }
      });

      // Format dropdown
      const formatDropdown = document.getElementById('formatDropdown');
      const formatBtn = document.getElementById('formatBtn');
      
      formatBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        formatDropdown.classList.toggle('open');
      });

      document.querySelectorAll('#formatDropdown .item').forEach(item => {
        item.addEventListener('click', () => {
          const format = item.dataset.format;
          selectedFormat = format;
          const label = format === 'rdfxml' ? 'RDF/XML' : format === 'ntriples' ? 'N-Triples' : 'Turtle Dataset';
          document.getElementById('formatLabel').textContent = label;
          formatDropdown.classList.remove('open');
          
          // Update RDF editor content based on format
          updateEditorForFormat(format);
        });
      });

      // Close dropdowns when clicking outside
      document.addEventListener('click', () => {
        document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
      });

      // Config panel
      document.getElementById('configBtn').addEventListener('click', () => {
        document.getElementById('configPanel').classList.add('open');
        document.getElementById('configOverlay').classList.add('open');
      });

      document.getElementById('configClose').addEventListener('click', closeConfig);
      document.getElementById('configOverlay').addEventListener('click', closeConfig);

      function closeConfig() {
        document.getElementById('configPanel').classList.remove('open');
        document.getElementById('sharePanel').classList.remove('open');
        document.getElementById('configOverlay').classList.remove('open');
      }

      // Help modal
      document.getElementById('helpBtn').addEventListener('click', () => {
        document.getElementById('helpModal').classList.add('open');
      });

      document.getElementById('helpClose').addEventListener('click', () => {
        document.getElementById('helpModal').classList.remove('open');
      });

      document.getElementById('helpModal').addEventListener('click', (e) => {
        if (e.target.id === 'helpModal') {
          document.getElementById('helpModal').classList.remove('open');
        }
      });

      // Share functionality
      document.getElementById('shareBtn').addEventListener('click', () => {
        const queries = queryEditors.map(e => e.getValue()).filter(q => q.trim());
        const rdf = rdfEditor.getValue();
        const n3logic = n3logicEditor ? n3logicEditor.getValue() : '';
        
        // Collect all rules from all rule editors
        const allRules = [];
        ruleEditors.forEach(editor => {
          const editorRules = parseMultipleRules(editor.getValue());
          allRules.push(...editorRules);
        });
        
        const state = {
          queries: queries,
          rdf: rdf,
          n3logic: n3logic,
          rules: allRules,
          format: selectedFormat
        };
        
        const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(state));
        const shareUrl = `${window.location.origin}${window.location.pathname}?q=${compressed}`;
        
        document.getElementById('shareUrlInput').value = shareUrl;
        document.getElementById('sharePanel').classList.add('open');
        document.getElementById('configOverlay').classList.add('open');
      });

      document.getElementById('shareClose').addEventListener('click', closeConfig);

      document.getElementById('shareCopyBtn').addEventListener('click', async () => {
        const urlInput = document.getElementById('shareUrlInput');
        const copyBtn = document.getElementById('shareCopyBtn');

        try {
          await navigator.clipboard.writeText(urlInput.value);
          copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
          copyBtn.classList.add('copied');
          setTimeout(() => {
            copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy to Clipboard';
            copyBtn.classList.remove('copied');
          }, 2000);
        } catch (error) {
          urlInput.select();
          document.execCommand('copy');
        }
      });

      // Font size controls
      document.getElementById('editorFontDecrease').addEventListener('click', () => {
        if (config.editorFontSize > 8) {
          config.editorFontSize--;
          updateEditorFontSize();
          saveConfig();
        }
      });

      document.getElementById('editorFontIncrease').addEventListener('click', () => {
        if (config.editorFontSize < 24) {
          config.editorFontSize++;
          updateEditorFontSize();
          saveConfig();
        }
      });

      document.getElementById('terminalFontDecrease').addEventListener('click', () => {
        if (config.terminalFontSize > 8) {
          config.terminalFontSize--;
          updateTerminalFontSize();
          saveConfig();
        }
      });

      document.getElementById('terminalFontIncrease').addEventListener('click', () => {
        if (config.terminalFontSize < 24) {
          config.terminalFontSize++;
          updateTerminalFontSize();
          saveConfig();
        }
      });

      document.getElementById('themeSelect').addEventListener('change', (e) => {
        config.theme = e.target.value;
        updateTheme();
        saveConfig();
      });
    }

    // Resizer functionality for SPARQL mode
    function setupResizer() {
      const resizer = document.getElementById('resizer');
      const container = document.getElementById('editor-container');
      const resultsPanel = document.getElementById('results-panel');
      
      let isResizing = false;
      let startY = 0;
      let startHeight = 0;

      resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        startY = e.clientY;
        startHeight = resultsPanel.offsetHeight;
        document.body.style.cursor = 'ns-resize';
        document.body.style.userSelect = 'none';
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const delta = startY - e.clientY;
        const newHeight = startHeight + delta;
        const containerHeight = container.offsetHeight;
        
        if (newHeight >= 200 && newHeight <= containerHeight * 0.8) {
          resultsPanel.style.minHeight = `${newHeight}px`;
          resultsPanel.style.maxHeight = `${newHeight}px`;
        }
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    }

    // Resizer functionality for RSP mode
    function setupResizerRsp() {
      const resizer = document.getElementById('resizer-rsp');
      const resultsPanel = document.getElementById('results-panel-rsp');
      
      if (!resizer || !resultsPanel) return;
      
      let isResizing = false;
      let startY = 0;
      let startHeight = 0;

      resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        startY = e.clientY;
        startHeight = resultsPanel.offsetHeight;
        document.body.style.cursor = 'ns-resize';
        document.body.style.userSelect = 'none';
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const delta = startY - e.clientY;
        const newHeight = startHeight + delta;
        
        if (newHeight >= 200 && newHeight <= window.innerHeight * 0.6) {
          resultsPanel.style.minHeight = `${newHeight}px`;
          resultsPanel.style.maxHeight = `${newHeight}px`;
        }
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    }

    // Parse multiple rules from a single text editor
    function parseMultipleRules(rulesText) {
      if (!rulesText || !rulesText.trim()) {
        return [];
      }

      const rules = [];
      const lines = rulesText.split('\n');
      let currentRule = [];
      let inRule = false;
      let hasSeenRuleKeyword = false;

      for (let line of lines) {
        const trimmedLine = line.trim();
        
        // Skip empty lines and comments when not in a rule
        if (!inRule && (trimmedLine === '' || trimmedLine.startsWith('#'))) {
          continue;
        }

        // Check if this line starts a new RULE (not PREFIX)
        // Only RULE keyword should start a new rule, PREFIX is part of the rule
        if (trimmedLine.toUpperCase().startsWith('RULE')) {
          if (currentRule.length > 0 && hasSeenRuleKeyword) {
            // Save previous rule
            rules.push(currentRule.join('\n'));
            currentRule = [];
          }
          inRule = true;
          hasSeenRuleKeyword = true;
        }

        // If we see PREFIX and we're not in a rule yet, or if we just finished a rule
        // this PREFIX belongs to the next rule
        if (trimmedLine.toUpperCase().startsWith('PREFIX')) {
          if (!inRule && currentRule.length === 0) {
            inRule = true;
          }
        }

        if (inRule) {
          currentRule.push(line);
        }
      }

      // Don't forget the last rule
      if (currentRule.length > 0) {
        rules.push(currentRule.join('\n'));
      }

      return rules.filter(r => r.trim());
    }

    // Modified execute function
    async function executeKolibrieQuery() {
      const rdfData = rdfEditor.getValue().trim();
      const format = selectedFormat;

      // Collect all queries
      const queries = queryEditors
        .map(editor => editor.getValue().trim())
        .filter(q => q.length > 0);

      // ONLY collect SPARQL rules from the Rules sub-panel (not N3 Logic)
      const allRules = [];
      ruleEditors.forEach(editor => {
        const editorRules = parseMultipleRules(editor.getValue());
        allRules.push(...editorRules);
      });

      // ONLY collect N3 Logic data from the N3 Logic sub-panel
      const n3logicData = n3logicEditor ? n3logicEditor.getValue().trim() : '';

      if (queries.length === 0) {
        addTerminalMessage('⚠ No queries provided', 'error');
        return;
      }

      const ruleCount = allRules.length;
      const n3logicNote = n3logicData ? ' + N3 Logic' : '';
      addTerminalMessage(`▶ Executing ${queries.length} query(ies) with ${ruleCount} SPARQL rule(s)${n3logicNote}...`, 'info');
      const startTime = performance.now();

      try {
        const payload = {
          queries: queries,
          rdf: rdfData || undefined,
          // SPARQL rules ONLY (from Rules sub-tab)
          rules: allRules.length > 0 ? allRules : undefined,
          // N3 logic ONLY (from N3 Logic sub-tab)
          n3logic: n3logicData || undefined,
          format: format
        };

        const response = await fetch('/query', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        const endTime = performance.now();
        const totalTime = (endTime - startTime).toFixed(2);

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const result = await response.json();
        displayMultipleResults(result, totalTime);

      } catch (error) {
        addTerminalMessage(`✗ Execution failed: ${error.message}`, 'error');
        console.error('Query execution error:', error);
      }
    }

    // Display results for multiple queries
    function displayMultipleResults(response, totalTime) {
      const content = document.getElementById('results-content');
      let html = '';

      html += `<div class="terminal-output terminal-success">✓ Executed ${response.results.length} query(ies) in ${totalTime}ms</div>`;

      response.results.forEach((queryResult, idx) => {
        html += `<div class="query-result-section">`;
        html += `<div class="terminal-output terminal-info"><strong>Query ${idx + 1}:</strong> ${queryResult.data.length} result(s) (${queryResult.execution_time_ms.toFixed(2)}ms)</div>`;

        if (queryResult.data.length > 0) {
          html += '<div class="table-wrapper"><table class="results-table">';

          // Header
          html += '<thead><tr>';
          queryResult.data[0].forEach(cell => {
            html += `<th>${escapeHtml(cell)}</th>`;
          });
          html += '</tr></thead>';

          // Rows
          html += '<tbody>';
          queryResult.data.slice(1).forEach(row => {
            html += '<tr>';
            row.forEach(cell => {
              html += `<td>${escapeHtml(cell)}</td>`;
            });
            html += '</tr>';
          });
          html += '</tbody></table></div>';
        } else {
          html += `<div class="terminal-output terminal-warning">⚠ Query ${idx + 1} returned no results</div>`;
        }

        html += `</div>`;
      });

      content.innerHTML = html;
    }

    function addTerminalMessage(message, type) {
      const content = document.getElementById('results-content');
      const messageDiv = document.createElement('div');
      messageDiv.className = `terminal-output terminal-${type}`;
      messageDiv.textContent = message;
      content.appendChild(messageDiv);
      content.scrollTop = content.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function executeRspQuery() {
      const query = rspSparqlEditor.getValue().trim();
      
      if (!query) {
        const content = document.getElementById('results-content-rsp');
        content.innerHTML = '<div class="terminal-output terminal-error">⚠ No query provided</div>';
        return;
      }

      const content = document.getElementById('results-content-rsp');
      content.innerHTML = '<div class="terminal-output terminal-info">▶ Executing RSP query...</div>';
      
      // Placeholder for RSP functionality
      setTimeout(() => {
        content.innerHTML = `
          <div class="terminal-output terminal-warning">⚠ RSP Mode is under development</div>
          <div class="terminal-output terminal-info">RSP-QL query received and validated. Stream processing will be implemented in a future update.</div>
        `;
      }, 500);
    }

    function updateEditorForFormat(format) {
      if (format === 'ntriples') {
        // Switch to N-Triples format
        rdfEditor.setValue(`<http://example.org/Room101> <http://example.org#temperature> "75" .
<http://example.org/Room101> <http://example.org#room> "Room101" .
<http://example.org/Sensor1> <http://example.org#room> "Room101" .
<http://example.org/Sensor1> <http://example.org#temperature> "90" .
<http://example.org/Room102> <http://example.org#temperature> "35" .
<http://example.org/Room102> <http://example.org#room> "Room102" .
<http://example.org/Sensor2> <http://example.org#room> "Room102" .
<http://example.org/Sensor2> <http://example.org#temperature> "70" .
<http://example.org/Room103> <http://example.org#temperature> "45" .
<http://example.org/Room103> <http://example.org#room> "Room103" .
<http://example.org/Sensor3> <http://example.org#room> "Room103" .
<http://example.org/Sensor3> <http://example.org#temperature> "95" .`);
      } else if (format === 'turtle') {
        // Switch to Turtle Dataset format (full IRIs only — no @prefix support)
        rdfEditor.setValue(`<http://example.org/Room101> <http://example.org#temperature> "75" .
<http://example.org/Room101> <http://example.org#room> "Room101" .
<http://example.org/Sensor1> <http://example.org#room> "Room101" .
<http://example.org/Sensor1> <http://example.org#temperature> "90" .
<http://example.org/Room102> <http://example.org#temperature> "35" .
<http://example.org/Room102> <http://example.org#room> "Room102" .
<http://example.org/Sensor2> <http://example.org#room> "Room102" .
<http://example.org/Sensor2> <http://example.org#temperature> "70" .
<http://example.org/Room103> <http://example.org#temperature> "45" .
<http://example.org/Room103> <http://example.org#room> "Room103" .
<http://example.org/Sensor3> <http://example.org#room> "Room103" .
<http://example.org/Sensor3> <http://example.org#temperature> "95" .`);
      } else {
        // Switch to RDF/XML format
        rdfEditor.setValue(`<?xml version="1.0"?>
<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
        xmlns:ex="http://example.org#">
<rdf:Description rdf:about="http://example.org#Room101">
    <ex:temperature>75</ex:temperature>
    <ex:room>Room101</ex:room>
</rdf:Description>
<rdf:Description rdf:about="http://example.org#Sensor1">
    <ex:room>Room101</ex:room>
    <ex:temperature>90</ex:temperature>
</rdf:Description>
<rdf:Description rdf:about="http://example.org#Room102">
    <ex:temperature>35</ex:temperature>
    <ex:room>Room102</ex:room>
</rdf:Description>
<rdf:Description rdf:about="http://example.org#Sensor2">
    <ex:room>Room102</ex:room>
    <ex:temperature>70</ex:temperature>
</rdf:Description>
<rdf:Description rdf:about="http://example.org#Room103">
    <ex:temperature>45</ex:temperature>
    <ex:room>Room103</ex:room>
</rdf:Description>
<rdf:Description rdf:about="http://example.org#Sensor3">
    <ex:room>Room103</ex:room>
    <ex:temperature>190</ex:temperature>
</rdf:Description>
</rdf:RDF>`);
      }
    }

    function loadFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const compressed = urlParams.get('q');
      
      if (compressed) {
        try {
          const decompressed = LZString.decompressFromEncodedURIComponent(compressed);
          const state = JSON.parse(decompressed);
          
          if (state.queries && state.queries.length > 0) {
            // Load first query
            queryEditors[0].setValue(state.queries[0]);
            
            // Add additional queries
            for (let i = 1; i < state.queries.length; i++) {
              addQueryEditor();
              queryEditors[i].setValue(state.queries[i]);
            }
          }
          
          if (state.rdf) {
            rdfEditor.setValue(state.rdf);
          }

          if (state.n3logic && n3logicEditor) {
            n3logicEditor.setValue(state.n3logic);
          }
          
          if (state.rules && state.rules.length > 0) {
            // Join all rules with double newlines for clarity
            const rulesText = state.rules.join('\n\n');
            ruleEditors[0].setValue(rulesText);
          }
          
          if (state.format) {
            selectedFormat = state.format;
            const label = state.format === 'rdfxml' ? 'RDF/XML' : state.format === 'ntriples' ? 'N-Triples' : 'Turtle Dataset';
            document.getElementById('formatLabel').textContent = label;
          }
        } catch (error) {
          console.error('Failed to load from URL:', error);
        }
      }
    }

    function updateEditorFontSize() {
      const fontSize = config.editorFontSize;
      document.getElementById('editorFontSize').textContent = `${fontSize}px`;
      const style = document.createElement('style');
      style.id = 'editor-font-style';
      const existingStyle = document.getElementById('editor-font-style');
      if (existingStyle) existingStyle.remove();
      style.textContent = `.CodeMirror { font-size: ${fontSize}px !important; }`;
      document.head.appendChild(style);
      queryEditors.forEach(e => e.refresh());
      rdfEditor.refresh();
      ruleEditors.forEach(e => e.refresh());
      if (n3logicEditor) n3logicEditor.refresh();
      if (rspSparqlEditor) rspSparqlEditor.refresh();
    }

    function updateTerminalFontSize() {
      const fontSize = config.terminalFontSize;
      document.getElementById('terminalFontSize').textContent = `${fontSize}px`;
      const style = document.createElement('style');
      style.id = 'terminal-font-style';
      const existingStyle = document.getElementById('terminal-font-style');
      if (existingStyle) existingStyle.remove();
      style.textContent = `.results-content { font-size: ${fontSize}px !important; }`;
      document.head.appendChild(style);
    }

    function updateTheme() {
      // Theme updates can be added here if needed
      // For now, keeping the default purple theme
    }

    function saveConfig() {
      localStorage.setItem('kolibrie-playground-config', JSON.stringify(config));
    }

    function loadConfig() {
      const saved = localStorage.getItem('kolibrie-playground-config');
      if (saved) {
        config = { ...config, ...JSON.parse(saved) };
      }
      document.getElementById('editorFontSize').textContent = `${config.editorFontSize}px`;
      document.getElementById('terminalFontSize').textContent = `${config.terminalFontSize}px`;
      document.getElementById('themeSelect').value = config.theme;
      updateEditorFontSize();
      updateTerminalFontSize();
      updateTheme();
    }

    // Initial message
    setTimeout(() => {
      document.getElementById('results-content').innerHTML = `
        <div class="terminal-output terminal-success"><i class="fas fa-rocket"></i> Kolibrie Playground Ready!

<strong>Quick Start:</strong>
1. Select your RDF format (RDF/XML or N-Triples) from the dropdown
2. Check the pre-loaded example in "RDF Data" tab
3. Review the rule in "Rules" tab (optional)
4. Click RUN to execute the example query

<strong>Multi-Query & Rules:</strong>
• Click "Add Query" to create query tabs for different tasks
• Write multiple rules in same tab to extend inference for one task
• Click "Add Rule Tab" to create separate rule sets for different tasks
• All queries execute in sequence with shared context

<strong>N3 Logic (in Rules tab):</strong>
• Switch to the "N3 Logic" sub-tab inside the Rules panel
• Write N3 logic inference rules — they are applied before SPARQL rules and queries
• Supports @prefix declarations and { premise } => { conclusion } syntax

<strong>About:</strong>
• Powered by Kolibrie SPARQL engine (Rust backend)
• Supports RDF/XML and N-Triples data loading
• N-Triples uses Streamertail optimizer for high performance
• Includes rule-based inference
• Real-time query execution

Click "Help" for more information.
        </div>
      `;

      document.getElementById('results-content-rsp').innerHTML = `
        <div class="terminal-output terminal-success"><i class="fas fa-stream"></i> Kolibrie RSP Mode Ready!

<strong>Quick Start:</strong>
1. Check the pre-loaded RSP-QL query example
2. Click RUN to execute the stream query
3. View real-time stream processing results

<strong>About RSP:</strong>
• RDF Stream Processing engine
• Window-based temporal queries
• Real-time data analysis
• Supports RSP-QL syntax

Click "Help" for more information.
        </div>
      `;
    }, 100);
  </script>
</body>
</html>